{% extends 'base.html' %}

{% block title %}GM League Season 2 Live Scores{% endblock %}

{% block content %}

<!-- Live Matches Section -->
<div class="live-matches-section mb-5">
    <div class="section-header">
        <h2 class="section-title">
            <span class="live-indicator"></span>Live Matches
        </h2>
        <p class="section-subtitle">Real-time updates from ongoing matches</p>
    </div>
    
    <div class="row">
        <!-- Football Match -->
        <div class="col-lg-6 col-md-6 mb-4">
            <div class="match-card" id="football-card">
                <div class="match-header">
                    <div class="sport-icon">
                        <i class="fas fa-futbol"></i>
                    </div>
                    <div class="match-info">
                        <h3 class="match-title">Football</h3>
                        <div class="match-status">
                            <span class="live-indicator" id="football-live-indicator" style="display: {{ 'inline-block' if scores['Football']['is_live'] else 'none' }};"></span>
                            <span class="status-badge {{ 'live' if scores['Football']['is_live'] else 'off' }}" id="football-live-badge">
                                {{ 'LIVE' if scores['Football']['is_live'] else 'OFF' }}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="match-score" id="football">
                    {{ scores['Football']['score'] if scores['Football']['score'] else 'No live match' }}
                </div>
                <div class="match-footer">
                    <span class="match-time">
                        <i class="fas fa-clock"></i>
                        <span id="football-status">{{ 'Live Match' if scores['Football']['is_live'] else 'Match Ended' }}</span>
                    </span>
                </div>
            </div>
        </div>

        <!-- Kabaddi Match -->
        <div class="col-lg-6 col-md-6 mb-4">
            <div class="match-card" id="kabaddi-card">
                <div class="match-header">
                    <div class="sport-icon">
                        <i class="fas fa-running"></i>
                    </div>
                    <div class="match-info">
                        <h3 class="match-title">Kabaddi</h3>
                        <div class="match-status">
                            <span class="live-indicator" id="kabaddi-live-indicator" style="display: {{ 'inline-block' if scores['Kabaddi']['is_live'] else 'none' }};"></span>
                            <span class="status-badge {{ 'live' if scores['Kabaddi']['is_live'] else 'off' }}" id="kabaddi-live-badge">
                                {{ 'LIVE' if scores['Kabaddi']['is_live'] else 'OFF' }}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="match-score" id="kabaddi">
                    {{ scores['Kabaddi']['score'] if scores['Kabaddi']['score'] else 'No live match' }}
                </div>
                <div class="match-footer">
                    <span class="match-time">
                        <i class="fas fa-clock"></i>
                        <span id="kabaddi-status">{{ 'Live Match' if scores['Kabaddi']['is_live'] else 'Match Ended' }}</span>
                    </span>
                </div>
            </div>
        </div>

        <!-- Basketball Match -->
        <div class="col-lg-6 col-md-6 mb-4">
            <div class="match-card" id="basketball-card">
                <div class="match-header">
                    <div class="sport-icon">
                        <i class="fas fa-basketball-ball"></i>
                    </div>
                    <div class="match-info">
                        <h3 class="match-title">Basketball</h3>
                        <div class="match-status">
                            <span class="live-indicator" id="basketball-live-indicator" style="display: {{ 'inline-block' if scores['Basketball']['is_live'] else 'none' }};"></span>
                            <span class="status-badge {{ 'live' if scores['Basketball']['is_live'] else 'off' }}" id="basketball-live-badge">
                                {{ 'LIVE' if scores['Basketball']['is_live'] else 'OFF' }}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="match-score" id="basketball">
                    {{ scores['Basketball']['score'] if scores['Basketball']['score'] else 'No live match' }}
                </div>
                <div class="match-footer">
                    <span class="match-time">
                        <i class="fas fa-clock"></i>
                        <span id="basketball-status">{{ 'Live Match' if scores['Basketball']['is_live'] else 'Match Ended' }}</span>
                    </span>
                </div>
            </div>
        </div>

        <!-- Badminton Match -->
        <div class="col-lg-6 col-md-6 mb-4">
            <div class="match-card" id="badminton-card">
                <div class="match-header">
                    <div class="sport-icon">
                        <i class="fas fa-table-tennis"></i>
                    </div>
                    <div class="match-info">
                        <h3 class="match-title">Badminton</h3>
                        <div class="match-status">
                            <span class="live-indicator" id="badminton-live-indicator" style="display: {{ 'inline-block' if scores['Badminton']['is_live'] else 'none' }};"></span>
                            <span class="status-badge {{ 'live' if scores['Badminton']['is_live'] else 'off' }}" id="badminton-live-badge">
                                {{ 'LIVE' if scores['Badminton']['is_live'] else 'OFF' }}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="match-score" id="badminton">
                    {{ scores['Badminton']['score'] if scores['Badminton']['score'] else 'No live match' }}
                </div>
                <div class="match-footer">
                    <span class="match-time">
                        <i class="fas fa-clock"></i>
                        <span id="badminton-status">{{ 'Live Match' if scores['Badminton']['is_live'] else 'Match Ended' }}</span>
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Players & Teams Section -->
<div class="committee-section">
    <h2 class="committee-title">
        <i class="fas fa-users me-2"></i>Players & Teams
    </h2>
    
    <!-- Sport Selection Dropdown -->
    <div class="row mb-4">
        <div class="col-md-6 mx-auto">
            <div class="form-group">
                <label for="player-sport-select" class="form-label">Select Sport to View Players</label>
                <select class="form-control" id="player-sport-select" onchange="loadPlayersDisplay()">
                    <option value="">All Sports</option>
                    <option value="Football">Football</option>
                    <option value="Kabaddi">Kabaddi</option>
                    <option value="Basketball">Basketball</option>
                    <option value="Badminton">Badminton</option>
                </select>
            </div>
        </div>
    </div>
    
    <div id="players-display-content">
        <div class="text-center">
            <p class="text-muted">Select a sport to view players</p>
        </div>
    </div>
</div>

<!-- PATRON Section -->
<div class="committee-section">
    <h2 class="committee-title">PATRON</h2>
    <div class="row">
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="committee-member">
                <div class="member-name">G.M. Lingaraju</div>
                <div class="member-role">Chancellor</div>
            </div>
        </div>
    </div>
</div>

<!-- ADVISORY COMMITTEE Section -->
<div class="committee-section">
    <h2 class="committee-title">ADVISORY COMMITTEE</h2>
    <div class="row">
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="committee-member">
                <div class="member-name">Dr. S.R. Shankapal</div>
                <div class="member-role">Vice Chancellor</div>
            </div>
        </div>
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="committee-member">
                <div class="member-name">Dr. H.D. Maheshappa</div>
                <div class="member-role">Pro-Vice Chancellor</div>
            </div>
        </div>
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="committee-member">
                <div class="member-name">Dr. Sunil Kumar B.S</div>
                <div class="member-role">Registrar</div>
            </div>
        </div>
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="committee-member">
                <div class="member-name">Dr. Kiran Kumar H S</div>
                <div class="member-role">Director - SA</div>
            </div>
        </div>
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="committee-member">
                <div class="member-name">Ajjaiah G B</div>
                <div class="member-role">Director - PE</div>
            </div>
        </div>
    </div>
</div>

<!-- Team Section -->
<div class="committee-section">
    <h2 class="committee-title">Team</h2>
    <div class="row">
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="committee-member">
                <div class="member-name">Gurushankar AS</div>
                <div class="member-role">Sports Secretary</div>
            </div>
        </div>
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="committee-member">
                <div class="member-name">Kumar M</div>
                <div class="member-role">Sports Secretary</div>
            </div>
        </div>
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="committee-member">
                <div class="member-name">Abhiram Girish Naik</div>
                <div class="member-role">Technical Lead</div>
            </div>
        </div>
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="committee-member">
                <div class="member-name">Yashaswini D S </div>
                <div class="member-role">Technical Lead</div>
            </div>
        </div>
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="committee-member">
                <div class="member-name">Rahul R Gadgimata</div>
                <div class="member-role">Technical Lead</div>
            </div>
        </div>
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="committee-member">
                <div class="member-name">Sudarshana V D</div>
                <div class="member-role">Core Member</div>
            </div>
        </div>
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="committee-member">
                <div class="member-name">Prajwal Jana</div>
                <div class="member-role">Core Member</div>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<div class="footer-section">
    <div class="footer-content">
        <p class="footer-text">
            <span class="trophy-icon">🏆</span> GM League Season 2
        </p>
        <p class="footer-copyright">
            © 2025 GM University. All rights reserved. | Season 2 - Where Legends Are Born
        </p>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Handle live status updates
socket.on('update_live_status', function(data) {
    const game = data.game.toLowerCase();
    const isLive = data.is_live;
    
    // Update live indicator
    const indicator = document.getElementById(`${game}-live-indicator`);
    const badge = document.getElementById(`${game}-live-badge`);
    const status = document.getElementById(`${game}-status`);
    
    if (indicator && badge && status) {
        if (isLive) {
            indicator.style.display = 'inline-block';
            badge.textContent = 'LIVE';
            badge.className = 'status-badge live';
            status.textContent = 'Live Match';
        } else {
            indicator.style.display = 'none';
            badge.textContent = 'OFF';
            badge.className = 'status-badge off';
            status.textContent = 'Match Ended';
        }
    }
});

// Update the existing score update handler to include live status
socket.on('update_score', function(data) {
    const scoreElement = document.getElementById(data.game.toLowerCase());
    if (scoreElement) {
        scoreElement.textContent = data.score_data;
        scoreElement.parentElement.classList.add('update-animation');
        setTimeout(() => {
            scoreElement.parentElement.classList.remove('update-animation');
        }, 500);
    }
});

// Load players on page load
document.addEventListener('DOMContentLoaded', function() {
    loadPlayersDisplay();
});

// Load and display players
function loadPlayersDisplay() {
    const sport = document.getElementById('player-sport-select').value;
    let url = '/api/players';
    if (sport) {
        url += `?sport=${sport}`;
    }
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            displayPlayersForViewers(data);
        })
        .catch(error => {
            console.error('Error loading players:', error);
        });
}

// Display players grouped by team for viewers
function displayPlayersForViewers(players) {
    const container = document.getElementById('players-display-content');
    
    if (players.length === 0) {
        container.innerHTML = '<div class="col-12 text-center"><p>No players found. Add players in the admin dashboard.</p></div>';
        return;
    }
    
    // Group players by team and sport
    const groupedTeams = {};
    players.forEach(player => {
        const key = `${player.sport}-${player.team}`;
        if (!groupedTeams[key]) {
            groupedTeams[key] = {
                sport: player.sport,
                team: player.team,
                players: [],
                totalPoints: 0,
                totalGoals: 0
            };
        }
        groupedTeams[key].players.push(player);
        groupedTeams[key].totalPoints += player.points;
        groupedTeams[key].totalGoals += player.goals;
    });
    
    let html = '<div class="row">';
    Object.values(groupedTeams).forEach(team => {
        const sportIcon = getSportIcon(team.sport);
        html += `
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="committee-member" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 300px;">
                    <div style="border-bottom: 2px solid rgba(255,255,255,0.3); padding-bottom: 15px; margin-bottom: 15px;">
                        <div class="member-name" style="font-size: 1.5rem; margin-bottom: 5px;">
                            <i class="fas fa-${sportIcon} me-2"></i>${team.team}
                        </div>
                        <div class="member-role" style="opacity: 0.9;">${team.sport}</div>
                        <div style="display: flex; justify-content: space-around; margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.8rem; font-weight: bold;">${team.totalPoints}</div>
                                <div style="font-size: 0.8rem; opacity: 0.9;">Total Points</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.8rem; font-weight: bold;">${team.totalGoals}</div>
                                <div style="font-size: 0.8rem; opacity: 0.9;">Total Goals</div>
                            </div>
                        </div>
                    </div>
                    <div style="max-height: 250px; overflow-y: auto;">
                        ${team.players.sort((a, b) => b.points - a.points).slice(0, 5).map((player, idx) => `
                            <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 10px; margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.2);">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <strong>${player.name}</strong>
                                    <span style="background: #f59e0b; padding: 2px 10px; border-radius: 5px; font-size: 0.85rem;">#${idx + 1}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 0.9rem; opacity: 0.9;">
                                    <span>Points: <strong>${player.points}</strong></span>
                                    <span>Goals: <strong>${player.goals}</strong></span>
                                </div>
                            </div>
                        `).join('')}
                        ${team.players.length > 5 ? `<div style="text-align: center; margin-top: 10px; opacity: 0.7;">+ ${team.players.length - 5} more players</div>` : ''}
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    container.innerHTML = html;
}

function getSportIcon(sport) {
    const icons = {
        'Football': 'futbol',
        'Kabaddi': 'running',
        'Basketball': 'basketball-ball',
        'Badminton': 'table-tennis'
    };
    return icons[sport] || 'gamepad';
}
</script>
{% endblock %}